<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IDMAR — Admin overrides do catálogo</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#fff;--border:#e5e7eb;--link:#0b6bcb}
    body{background:var(--bg);color:var(--fg);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .container{max-width:1100px;margin:1rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    label{display:block;margin:.35rem 0 .25rem}
    input,select,textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;background:#fff}
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    button.btn-secondary{background:#111827}
    button.btn-danger{background:#ef4444}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .small{opacity:.75}
    pre{background:#f6f7f9;border:1px solid var(--border);border-radius:10px;padding:.75rem;overflow:auto;max-height:50vh}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:.5rem;text-align:left;font-size:.95rem}
    .tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.1rem .5rem;margin:.1rem .25rem 0 0;background:#f8fafc}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap}
  </style>
</head>
<body>
  <main class="container">
    <h1 style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
      <button class="btn-secondary" onclick="location.href='validador.html'">← Validador</button>
      <span>Admin — Overrides do catálogo</span>
    </h1>
    <p class="small">Guarda em <code>localStorage["IDMAR_ENGINE_OVERRIDES"]</code>. O picker r5 aplica estes dados por cima do catálogo v2.</p>

    <div class="panel">
      <div class="row">
        <div>
          <label>Marca / Brand</label>
          <input id="brand" placeholder="ex.: Yamaha">
        </div>
        <div>
          <label>Família (opcional, apenas para organização)</label>
          <input id="family" placeholder="ex.: F115 (1.8 DOHC)">
        </div>
      </div>

      <label>Modelos (vírgulas) — aparecem no autocomplete do picker</label>
      <textarea id="models" rows="2" placeholder="ex.: F115B,F130A,F150D,VF150,XF425"></textarea>

      <div class="row">
        <div>
          <label>Potências (hp, vírgulas)</label>
          <input id="hp" placeholder="ex.: 115,130,150,300,425">
        </div>
        <div>
          <label>Cilindradas (cc, vírgulas)</label>
          <input id="disp" placeholder="ex.: 1832,2670,4169,5559">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Anos (vírgulas)</label>
          <input id="years" placeholder="ex.: 2014,2015,2025">
        </div>
        <div>
          <label>Rigging (vírgulas)</label>
          <input id="rig" placeholder="ex.: Mechanical,DEC/DBW,Tiller">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Shaft (vírgulas)</label>
          <input id="shaft" placeholder="ex.: S,L,XL,XX">
        </div>
        <div>
          <label>Observações (opcional)</label>
          <input id="notes" placeholder="ex.: etiqueta na braçadeira (bb)">
        </div>
      </div>

      <div class="actions" style="margin-top:.75rem">
        <button id="save">Guardar override</button>
        <button class="btn-secondary" id="notify">Notificar picker</button>
        <button class="btn-secondary" id="export">Exportar JSON</button>
        <button class="btn-secondary" id="import">Importar JSON</button>
        <button class="btn-danger" id="clear">Limpar tudo</button>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:.25rem 0 .5rem">Overrides atuais</h3>
      <div id="list"></div>
    </div>

    <div class="panel">
      <div class="small" style="margin-bottom:.35rem">Conteúdo cru (<code>IDMAR_ENGINE_OVERRIDES</code>)</div>
      <pre id="raw">{}</pre>
    </div>
  </main>

  <script>
    const KEY = 'IDMAR_ENGINE_OVERRIDES';
    const $ = id => document.getElementById(id);
    const parseList = (str, mapFn) =>
      (str||'').split(',').map(s=>s.trim()).filter(Boolean).map(mapFn||((x)=>x));

    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
    function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj, null, 2)); render(); }
    function emit(){ try{ window.dispatchEvent(new Event('idmar:engine-overrides-changed')); }catch(e){} }

    function upsert(){
      const brand = $('brand').value.trim(); if(!brand){ alert('Indica a marca.'); return; }
      const family = ($('family').value || '_generic').trim() || '_generic';

      const models = parseList($('models').value);
      const hp     = parseList($('hp').value,   x=>Number(x)).filter(x=>!isNaN(x));
      const disp   = parseList($('disp').value, x=>Number(x)).filter(x=>!isNaN(x));
      const years  = parseList($('years').value,x=>Number(x)).filter(x=>!isNaN(x));
      const rig    = parseList($('rig').value);
      const shaft  = parseList($('shaft').value);
      const notes  = $('notes').value.trim();

      const all = load();
      all[brand] = all[brand] || {};
      const dedup = a => Array.from(new Set((a||[]).filter(Boolean)));
      all[brand].model_code_list   = dedup([...(all[brand].model_code_list||[]), ...models]);
      all[brand].hp_list           = dedup([...(all[brand].hp_list||[]), ...hp]);
      all[brand].displacement_list = dedup([...(all[brand].displacement_list||[]), ...disp]);
      all[brand].year_list         = dedup([...(all[brand].year_list||[]), ...years]);
      all[brand].rigging           = dedup([...(all[brand].rigging||[]), ...rig]);
      all[brand].shaft_options     = dedup([...(all[brand].shaft_options||[]), ...shaft]);

      all[brand].families = all[brand].families || {};
      const F = all[brand].families[family] = all[brand].families[family] || {};
      if (models.length) F.model_code_list   = dedup([...(F.model_code_list||[]), ...models]);
      if (hp.length)     F.hp_list           = dedup([...(F.hp_list||[]), ...hp]);
      if (disp.length)   F.displacement_list = dedup([...(F.displacement_list||[]), ...disp]);
      if (years.length)  F.year_list         = dedup([...(F.year_list||[]), ...years]);
      if (rig.length)    F.rigging           = dedup([...(F.rigging||[]), ...rig]);
      if (shaft.length)  F.shaft_options     = dedup([...(F.shaft_options||[]), ...shaft]);
      if (notes)         F.notes = notes;

      save(all);
    }

    function delBrand(brand){
      const all = load();
      if (!all[brand]) return;
      if (confirm(`Apagar overrides da marca "${brand}"?`)) { delete all[brand]; save(all); }
    }
    function delFamily(brand,fam){
      const all = load();
      if (!all[brand]?.families?.[fam]) return;
      if (confirm(`Apagar família "${fam}" em "${brand}"?`)) {
        delete all[brand].families[fam];
        if (!Object.keys(all[brand].families).length) delete all[brand].families;
        save(all);
      }
    }

    function render(){
      const all = load();
      $('raw').textContent = JSON.stringify(all, null, 2);

      const host = $('list');
      host.innerHTML = '';
      const brands = Object.keys(all).sort();

      if (!brands.length) { host.innerHTML = '<div class="small">Sem overrides.</div>'; return; }

      brands.forEach(b => {
        const card = document.createElement('div');
        card.className = 'panel';
        const title = `<h3 style="margin:.15rem 0 .5rem">${b}</h3>`;
        const tag = (lbl, arr) => (arr&&arr.length) ? `<div style="margin:.25rem 0"><strong>${lbl}:</strong> ${(arr||[]).map(x=>`<span class="tag">${x}</span>`).join(' ')}</div>` : '';
        const topTags = `<div class="small">
            ${tag('Modelos', all[b].model_code_list)}
            ${tag('HP', all[b].hp_list)}
            ${tag('Disp', all[b].displacement_list)}
            ${tag('Anos', all[b].year_list)}
            ${tag('Rig', all[b].rigging)}
            ${tag('Shaft', all[b].shaft_options)}
          </div>`;

        const fams = all[b].families || {};
        let famTable = '';
        if (Object.keys(fams).length) {
          famTable = `<table><thead><tr><th>Família</th><th>Modelos</th><th>HP</th><th>Disp</th><th>Anos</th><th>Rig</th><th>Shaft</th><th></th></tr></thead><tbody>` +
            Object.entries(fams).map(([name,F]) =>
              `<tr>
                <td>${name}</td>
                <td>${(F.model_code_list||[]).join(', ')}</td>
                <td>${(F.hp_list||[]).join(', ')}</td>
                <td>${(F.displacement_list||[]).join(', ')}</td>
                <td>${(F.year_list||[]).join(', ')}</td>
                <td>${(F.rigging||[]).join(', ')}</td>
                <td>${(F.shaft_options||[]).join(', ')}</td>
                <td><button class="btn-danger" data-del="${b}::${name}">Apagar</button></td>
              </tr>`).join('') + '</tbody></table>';
        }

        const actions = `<div class="actions" style="margin-top:.5rem">
          <button class="btn-danger" data-delbrand="${b}">Apagar marca</button>
          <button class="btn-secondary" onclick="window.dispatchEvent(new Event('idmar:engine-overrides-changed'))">Notificar picker</button>
        </div>`;

        card.innerHTML = title + topTags + famTable + actions;
        host.appendChild(card);
      });

      host.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const [brand,fam] = btn.getAttribute('data-del').split('::');
          delFamily(brand,fam);
        });
      });
      host.querySelectorAll('[data-delbrand]').forEach(btn => {
        btn.addEventListener('click', () => delBrand(btn.getAttribute('data-delbrand')));
      });
    }

    document.getElementById('save').addEventListener('click', () => { upsert(); alert('Override guardado.'); });
    document.getElementById('notify').addEventListener('click', () => { emit(); alert('Picker notificado.'); });
    document.getElementById('export').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(load(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'idmar_overrides.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('import').addEventListener('click', async () => {
      const picker = document.createElement('input'); picker.type='file'; picker.accept='application/json';
      picker.onchange = async () => {
        const f = picker.files?.[0]; if(!f) return;
        try{
          const txt = await f.text();
          const json = JSON.parse(txt);
          save(json);
          alert('Overrides importados.');
          emit();
        }catch(e){ alert('Ficheiro inválido.'); }
      };
      picker.click();
    });
    document.getElementById('clear').addEventListener('click', () => {
      if (confirm('Limpar TODOS os overrides?')){ localStorage.removeItem(KEY); render(); emit(); }
    });

    render();
  </script>
</body>
</html>
