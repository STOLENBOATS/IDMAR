<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IDMAR — Admin motores (overrides locais)</title>
  <link rel="icon" href="img/logo-pm.png"/>

  <!-- CSS base (mesmos da app) -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <link rel="stylesheet" href="css/nav-ribbon.v5.css">

  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#fff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
         font-size:16.5px}
    main{flex:1}
    .container{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    label{display:block;margin:.35rem 0 .25rem}
    input,select,textarea{width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem}
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .small{opacity:.75}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
    .btn-secondary{background:#111827;color:#fff}
    .btn-danger{background:#ef4444}
    pre{background:#f6f7f9;border:1px solid var(--border);border-radius:10px;padding:.75rem;overflow:auto}
  </style>

  <!-- Gate de sessão simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>

  <!-- Versão + header iguais às outras páginas -->
  <script>window.IDMAR_VERSION="Vs 1.3";</script>
  <script defer src="js/idmar-config.v4.js"></script>
  <script defer src="js/idmar-i18n.js"></script>
  <script defer src="js/idmar-header-only.all.v4.js"></script>
  <script defer src="js/header-override.v4.js"></script>
  <script defer src="js/i18n-boot.js"></script>
  <script defer src="js/idmar-version.v4.js"></script>
</head>

<body>
  <!-- header é injetado por JS -->

  <main class="container">
    <h1 style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
      <button onclick="location.href='validador.html'" class="btn-secondary" title="Voltar ao Validador / Back to Validator">← Voltar ao Validador</button>
      <span>Admin — Overrides de Catálogo (localStorage)</span>
    </h1>
    <p class="small">Escreve em <code>localStorage["IDMAR_ENGINE_OVERRIDES"]</code>. Útil para testar novas entradas sem editar o JSON. Após guardar, o Validador atualiza o picker automaticamente.</p>

    <div class="panel">
      <div class="row">
        <div>
          <label>Marca / Brand</label>
          <select id="brand">
            <option>Yamaha</option><option>Suzuki</option><option>Honda</option><option>Mercury</option>
            <option>Tohatsu</option><option>Evinrude/Johnson</option><option>Volvo Penta</option><option>MerCruiser</option>
          </select>
        </div>
        <div>
          <label>Família / Family (opcional)</label>
          <input id="family" placeholder="ex.: F115B / DF140A / BF100 / etc.">
        </div>
      </div>

      <label>Modelo / Model code (vírgulas)</label>
      <textarea id="model" rows="2" placeholder="ex.: F115B,F150D,VF150,XTO425"></textarea>

      <label>Potência (hp) / Power (vírgulas)</label>
      <textarea id="hp" rows="2" placeholder="ex.: 2.5,4,6,8,9.9,15,20,25,30,40,50,60,70,90,115,150,175,200,225,250,300,425"></textarea>

      <div class="row">
        <div>
          <label>Cilindrada (cc) / Displacement (vírgulas)</label>
          <input id="disp" placeholder="ex.: 5559,4169,2785,1832,996">
        </div>
        <div>
          <label>Anos / Years (vírgulas)</label>
          <input id="years" placeholder="ex.: 1998,1999,...,2025">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Comando / Rigging (vírgulas)</label>
          <input id="rig" placeholder="ex.: DEC/DBW,Mechanical,Tiller">
        </div>
        <div>
          <label>Altura / Shaft (vírgulas)</label>
          <input id="shaft" placeholder="ex.: S,L,X,XL,U,UL,XX">
        </div>
      </div>

      <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="save">Guardar override</button>
        <button id="clear" class="btn-danger">Limpar todos</button>
        <button class="btn-secondary" onclick="location.href='validador.html'">Fechar</button>
      </div>
    </div>

    <div class="panel">
      <div class="small" style="margin-bottom:.5rem">Conteúdo atual de <strong>IDMAR_ENGINE_OVERRIDES</strong></div>
      <pre id="out">{}</pre>
    </div>
  </main>

  <footer class="footer">IDMAR — Identificação Marítima</footer>

    <script>
  // ===== Admin overrides para schema v2 =====
  const KEY_V2 = 'IDMAR_ENGINE_OVERRIDES_V2';
  const $ = id => document.getElementById(id);
  const parseList = (str, mapFn) =>
    (str||'').split(',').map(s=>s.trim()).filter(Boolean).map(mapFn||((x)=>x));

  function loadV2(){ try{ return JSON.parse(localStorage.getItem(KEY_V2)||'{"schema":"engines_catalog.v2","brands":{}}'); }catch(e){ return {"schema":"engines_catalog.v2","brands":{}}; } }
  function saveV2(obj){ localStorage.setItem(KEY_V2, JSON.stringify(obj, null, 2)); }
  function renderV2(){ $('out').textContent = localStorage.getItem(KEY_V2) || '{"schema":"engines_catalog.v2","brands":{}}'; }

  // Constrói versões v2 a partir dos campos do formulário
  function buildV2Entries(brand, familyName, models, powers, disps, yearsList, rigList, shaftList){
    const family = {
      display: familyName,
      version_options: models,
      power_options: powers,
      versions: []
    };
    // regra: cartesian minimal (se der, alinha 1:1 por índice; senão, combina todos powers com todos models)
    const useZip = models.length === powers.length && models.length > 0;
    if(useZip){
      for(let i=0;i<models.length;i++){
        family.versions.push({
          version: models[i],
          power: Number(powers[i]),
          displacement_cc: disps[0] || undefined,
          years: yearsList.length ? yearsList.join(',') : '',
          rigging: rigList.join(','),
          shaft: shaftList.join(','),
          rotation: '',
          gearcase: '',
          serial: { notes: '', ranges: [] }
        });
      }
    } else {
      models.forEach(m=>{
        powers.forEach(p=>{
          family.versions.push({
            version: m,
            power: Number(p),
            displacement_cc: disps[0] || undefined,
            years: yearsList.length ? yearsList.join(',') : '',
            rigging: rigList.join(','),
            shaft: shaftList.join(','),
            rotation: '',
            gearcase: '',
            serial: { notes: '', ranges: [] }
          });
        });
      });
    }
    return family;
  }

  // Botões/ações
  (function arm(){
    const btnSave = document.createElement('button');
    btnSave.textContent = 'Guardar override (v2)';
    btnSave.id = 'saveV2';
    $('save').replaceWith(btnSave);

    const btnExport = document.createElement('button');
    btnExport.textContent = 'Exportar v2 JSON';
    btnExport.className = 'btn-secondary';
    btnExport.style.marginLeft = '.5rem';
    btnExport.id = 'exportV2';
    btnSave.insertAdjacentElement('afterend', btnExport);

    const btnClear = $('clear');

    btnSave.onclick = function(){
      const brand = $('brand').value.trim();
      const familyName = ($('family').value || '_generic').trim() || '_generic';

      const models = parseList($('model').value);            // modelos (ex.: F115B,F150D)
      const powers = parseList($('hp').value, x=>Number(x)).filter(x=>!isNaN(x));
      const disps  = parseList($('disp').value, x=>Number(x)).filter(x=>!isNaN(x));
      const years  = parseList($('years').value, x=>x);      // deixar string livre
      const rigs   = parseList($('rig').value);
      const shafts = parseList($('shaft').value);

      if(!brand){ alert('Seleciona uma marca.'); return; }
      if(!models.length && !powers.length){ alert('Preenche pelo menos Modelos e/ou Potências.'); return; }

      const all = loadV2();
      all.schema = 'engines_catalog.v2';
      all.brands = all.brands || {};
      all.brands[brand] = all.brands[brand] || { families: {} };

      const famObj = buildV2Entries(brand, familyName, models, powers, disps, years, rigs, shafts);
      all.brands[brand].families[familyName] = famObj; // overwrite simples (override)

      saveV2(all);
      renderV2();

      // Notifica outras tabs (Validador) para recarregar
      try { localStorage.setItem('__IDMAR_EVT__', String(Date.now())); } catch(_){}
      window.dispatchEvent(new CustomEvent('idmar:catalog-overrides-updated'));

      alert('Override (v2) guardado em localStorage.');
    };

    btnExport.onclick = function(){
      const blob = new Blob([ localStorage.getItem(KEY_V2) || '' ], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'engines_overrides.v2.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    btnClear.onclick = function(){
      if(confirm('Limpar TODOS os overrides v2?')){
        localStorage.removeItem(KEY_V2);
        renderV2();
      }
    };

    renderV2();
  })();
</script>
</body>
</html>
