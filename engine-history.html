<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IDMAR — Histórico de motores</title>
  <link rel="icon" href="img/logo-pm.png"/>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#fff;--border:#e5e7eb;--link:#0b6bcb}
    body{background:var(--bg);color:var(--fg);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:.5rem .4rem;text-align:left;font-size:14px}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .btn-secondary{background:#111827;color:#fff}
    .btn-danger{background:#ef4444}
    input[type="search"]{width:260px;border:1px solid var(--border);border-radius:10px;padding:.4rem .6rem}
  </style>
</head>
<body>
<main>
  <h1>Histórico de motores</h1>
  <div class="row">
    <button class="btn-secondary" onclick="location.href='validador.html'">← Voltar ao Validador</button>
    <input id="q" type="search" placeholder="procurar por modelo, série, notas…">
    <button id="exportCsv">Exportar CSV</button>
    <button id="clear" class="btn-danger">Limpar tudo</button>
  </div>
  <div class="panel">
    <table>
      <thead><tr>
        <th>Data</th><th>Marca</th><th>Modelo</th><th>Nº série</th><th>Versão</th><th>Potência</th><th>Notas</th><th></th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script src="js/engine-history.v1.js"></script>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const tbody = $('#tbody');
  const q = $('#q');

  function render(list){
    tbody.innerHTML = '';
    list.forEach(r => {
      const tr = document.createElement('tr');
      const td = (t)=>{ const x=document.createElement('td'); x.textContent=t||''; return x; };
      tr.appendChild(td(new Date(r.ts).toLocaleString()));
      tr.appendChild(td(r.brand));
      tr.appendChild(td(r.model));
      tr.appendChild(td(r.serial && (r.serial.raw || r.serial)));
      tr.appendChild(td(r.family && r.family.version));
      tr.appendChild(td(r.family && r.family.power));
      tr.appendChild(td(r.notes));
      const del = document.createElement('td');
      const b = document.createElement('button');
      b.textContent = 'Apagar';
      b.className = 'btn-danger';
      b.onclick = ()=>{ EngineHistory.removeByTs(r.ts); load(); };
      del.appendChild(b);
      tr.appendChild(del);
      tbody.appendChild(tr);
    });
  }

  function load(){
    const list = EngineHistory.all();
    const term = (q.value || '').toLowerCase();
    const filt = !term ? list : list.filter(r => JSON.stringify(r).toLowerCase().includes(term));
    render(filt);
  }

  $('#exportCsv').onclick = ()=>{
    const csv = EngineHistory.toCSV(EngineHistory.all());
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'idmar_engine_history.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
  $('#clear').onclick = ()=>{
    if(confirm('Limpar todo o histórico?')){ EngineHistory.clear(); load(); }
  };
  q.addEventListener('input', load);

  load();
})();
</script>
</body>
</html>
