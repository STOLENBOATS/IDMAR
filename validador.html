<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR  Validador</title>
  <link rel="icon" href="img/logo-pm.png" />
  <link rel="apple-touch-icon" href="img/logo-pm.png" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b6bcb">

  <!-- CSS base -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <link rel="stylesheet" href="css/nav-ribbon.v5.css">

  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .three{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:1100px){ .three{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input[type="text"], input[type="search"], input[type="file"], select, textarea{
      width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem;
    }
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid var(--border);padding:.6rem .5rem;text-align:left}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
    .muted{opacity:.75}
    #engine-sn-window .chip{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.15rem .5rem;margin:.15rem .25rem 0 0}
    #engine-sn-result ul{margin:.25rem 0 0 .9rem}
  </style>

  <!-- Gate de sessão simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>

  <!-- Versão + branding -->
  <script>window.IDMAR_VERSION="Vs 1.3";</script>
  <script defer src="js/idmar-config.v4.js"></script>

  <!-- Core: i18n + header -->
  <script defer src="js/idmar-i18n.js"></script>
  <script defer src="js/idmar-header-only.all.v4.js"></script>

  <!-- Overrides (aplicam labels, ribbons e rodapé) -->
  <script defer src="js/header-override.v4.js"></script>
  <script defer src="js/i18n-boot.js"></script>
  <script defer src="js/idmar-version.v4.js"></script>
</head>

<body>
  <!-- header é injetado por JS -->

  <main class="container">
    <h1 class="card-title" data-bi-pt="Validador" data-bi-en="Validator"></h1>

    <section class="three">
      <!-- WIN -->
      <div class="panel" id="card-win">
        <h2 class="card-title" data-bi-pt="Validador WIN" data-bi-en="WIN Validator"></h2>
        <form id="formWin">
          <label for="win">WIN / HIN</label>
          <input id="win" type="text" placeholder="Ex.: PT-ABC12345D404"/>
          <div style="margin:.5rem 0">
            <button id="btnWin" type="submit">Validar WIN</button>
          </div>

          <div style="margin-top:.5rem">
            <label for="winPhoto">Foto opcional / Optional photo</label>
            <input id="winPhoto" type="file" accept="image/*"/>
          </div>

          <div id="winOut" style="margin-top:.75rem"></div>

          <table>
            <thead>
              <tr><th>Campo / Field</th><th>Valor / Value</th><th>Interpretação / Meaning</th></tr>
            </thead>
            <tbody id="interpWinBody"></tbody>
          </table>
        </form>
      </div>

      <!-- MOTOR -->
      <div class="panel" id="card-motor">
        <h2 class="card-title" data-bi-pt="Validador Motor" data-bi-en="Engine Validator"></h2>
        <form id="formMotor">
          <label for="brand">Marca</label>
          <select id="brand" data-engine-field="brand">
            <option>Yamaha</option><option>Honda</option><option>Suzuki</option><option>Tohatsu</option>
            <option>Mercury</option><option>MerCruiser</option><option>Volvo Penta</option>
            <option>Yanmar</option><option>Evinrude/Johnson</option>
          </select>

          <div id="brandDynamic"></div>

          <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem">
            <div>
              <label>Modelo (pesquisa)</label>
              <input id="srch_model" type="text" placeholder="Ex.: BF40A / DF140A" data-engine-field="model_code"/>
            </div>
            <div>
              <label>Potência (hp)</label>
              <input id="srch_power" type="text" placeholder="Ex.: 150" data-engine-field="power"/>
            </div>
            <div>
              <label>Cilindrada (cc)</label>
              <input id="srch_disp" type="text" placeholder="Ex.: 2670" data-engine-field="displacement"/>
            </div>
            <div>
              <label>Ano</label>
              <input id="srch_year" type="text" placeholder="Ex.: 2017" data-engine-field="year"/>
            </div>
            <div>
              <label>Origem</label>
              <input id="srch_origin" type="text" placeholder="Ex.: Japão" data-engine-field="origin"/>
            </div>
          </div>

          <div style="margin:.5rem 0">
            <button id="btnMotor" type="submit">Validar Motor</button>
          </div>

          <!-- Family Picker (versão / potência / intervalos SN) -->
          <link rel="stylesheet" href="./css/engine-family.css">
          <div class="ef-grid">
            <div class="ef-field">
              <label for="engineVersion" class="ef-label">Versão</label>
              <select id="engineVersion" class="ef-select"><option value="">—</option></select>
            </div>
            <div class="ef-field">
              <label for="enginePower" class="ef-label">Potência</label>
              <select id="enginePower" class="ef-select"><option value="">—</option></select>
            </div>
            <div class="ef-field">
              <label class="ef-label">Nº Série (intervalos)</label>
              <div id="engineSerialInfo"></div>
            </div>
          </div>
        </form>
      </div>

      <!-- Nº do motor / Serial -->
      <div class="panel" id="card-serial">
        <h2 class="card-title" data-bi-pt="Nº do motor / Engine serial" data-bi-en="Engine serial"></h2>
        <input id="engine-sn-raw" type="text"
               placeholder="Ex.: BF40A-BAAL-1234567, BAAL-1234567, 1B123456" autocomplete="off" />
        <div class="sn-kind" style="margin-top:.5rem">
          <label><input type="radio" name="engine-sn-kind" value="auto" checked> Auto</label>
          <label><input type="radio" name="engine-sn-kind" value="exterior"> Exterior</label>
          <label><input type="radio" name="engine-sn-kind" value="interior"> Interior</label>
        </div>
        <div id="engine-sn-window" class="mt-2"></div>
        <small id="engine-sn-hints" class="muted"></small>
        <div id="engine-sn-result" class="mt-2"></div>
      </div>
    </section>
  </main>

  <footer class="footer" id="fallback-footer">IDMAR  Identificação Marítima</footer>

  <!-- Scripts específicos WIN/Motor -->
  <script src="js/validador-win.r3b.js?v=r3b"></script>
  <script src="js/validador-motor.r3d.js?v=r3d"></script>
  <script defer src="js/validator-enhancements.v4.js"></script>

  <!-- Validador de combinações -->
  <script defer src="js/engine_validation.v1.js"></script>

  <!-- Admin rápido embutido (opcional) -->
  <!-- <script defer src="js/engine_admin_embed.v1.js"></script> -->

  <!-- Ribbon Admin -->
  <script>window.IDMAR_ADMIN_URL = 'admin-engines.html';</script>
  <script defer src="js/ribbon-admin.v1.js"></script>

  <!-- Autocomplete antigo (schema v1) -->
  <script type="module" src="js/engine_autocomplete_addon.v1.js" data-catalog="data/engines_catalog.v1.json"></script>
  <script defer src="js/patch-forense-i18n-ribbon.r1.js?v=r1"></script>

  <!-- PWA / SW -->
  <script defer src="./js/sw-register.js"></script>

  <!-- Engine Picker UNIFICADO -->
  <link rel="stylesheet" href="./css/engine-picker.css">
  <script defer src="./js/engine-picker.js?v=r4"></script>
  <div id="engine-picker"></div>

  <!-- INIT picker com fallback v2→v1 e espera pelo script -->
  <script data-picker-init>
    window.addEventListener('DOMContentLoaded', async () => {
      const tryUrl = './data/engines_catalog.v2.json';
      const fallback = './data/engines_catalog.v1.json';
      let url = fallback;
      try {
        const r = await fetch(tryUrl);
        const j = await r.json();
        const hasBrands =
          Array.isArray(j) ||
          Array.isArray(j.brands) || (j.brands && typeof j.brands === 'object') ||
          Array.isArray(j?.data?.brands) || (j?.data?.brands && typeof j.data.brands === 'object') ||
          Array.isArray(j.manufacturers) || (j.manufacturers && typeof j.manufacturers === 'object');
        url = hasBrands ? tryUrl : fallback;
      } catch {}
      const wait = (test, cb, tries = 50) => {
        const t = setInterval(() => {
          if (test()) { clearInterval(t); cb(); }
          else if (!--tries) clearInterval(t);
        }, 100);
      };
      wait(() => window.EnginePicker && typeof EnginePicker.init === 'function', () => {
        EnginePicker.init({ dataUrl: url });
        console.log('[IDMAR] EnginePicker usando', url);

        // Se houver marca legacy já selecionada, reflete no picker
        const legacyBrand = document.getElementById('brand');
        const pickerBrand = document.getElementById('engineBrand');
        if (legacyBrand && pickerBrand && legacyBrand.value) {
          pickerBrand.value = legacyBrand.value;
          pickerBrand.dispatchEvent(new Event('change'));
        }
      });
    });
  </script>

  <!-- Sync seguro (2 vias): #srch_model ↔ #engineModel e #brand ↔ picker -->
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    function connectOnce() {
      const legacyBrand = document.getElementById('brand');
      const legacyModel = document.getElementById('srch_model');
      const pickerInput = document.getElementById('engineModel');   // criado pelo picker
      const pickerBrand = document.getElementById('engineBrand');   // criado pelo picker
      if (!legacyModel || !pickerInput) return;

      // Modelo: bidirecional
      legacyModel.addEventListener('input', () => pickerInput.value = legacyModel.value);
      pickerInput.addEventListener('input', () => legacyModel.value = pickerInput.value);

      // Marca: refletir alterações do legacy para o picker (sem loops)
      if (legacyBrand && pickerBrand) {
        if (legacyBrand.value) {
          pickerBrand.value = legacyBrand.value;
          pickerBrand.dispatchEvent(new Event('change'));
        }
        legacyBrand.addEventListener('change', () => {
          pickerBrand.value = legacyBrand.value;
          pickerBrand.dispatchEvent(new Event('change'));
        });
      }
    }
    // quando o picker injetar os campos, ligamos
    setTimeout(connectOnce, 0);
  });
  </script>

  <!-- Campos por marca -->
  <link rel="stylesheet" href="./css/engine-brand.css">
  <div id="engine-brand-fields"></div>
  <script defer src="./js/engine-brand-config.v1.js"></script>
  <script defer src="./js/engine-brand-fields.v1.js"></script>

  <!-- Family picker -->
  <script defer src="./js/engine-family-picker.v1.js"></script>

  <!-- Nº Motor: parser + ranges + painel (se existirem estes ficheiros no repo) -->
  <script defer src="js/validators/engine-sn.v1.js?v=r7"></script>
  <script defer src="js/engine-serial-range-check.v1.js?v=r8"></script>
  <script defer src="js/engine-sn-panel.v2.js?v=r2"></script>

  <!-- Stubs de segurança: se os ficheiros acima não existirem, evita erros -->
  <script>
    (function(w,d){
      if(!w.EngineSNRange){
        w.EngineSNRange = { check: sn => ({ ok: !!(sn && sn.trim()), ranges: [], notes: '' }) };
      }
      // painel mínimo se não houver ficheiro real
      if(!w.__SN_PANEL_FALLBACK__){
        w.__SN_PANEL_FALLBACK__ = true;
        const input = d.getElementById('engine-sn-raw');
        const out = d.getElementById('engine-sn-result');
        if (input && out) {
          input.addEventListener('input', () => {
            const res = (w.EngineSNRange && w.EngineSNRange.check)
              ? w.EngineSNRange.check(input.value || '')
              : { ok: !!(input.value||'').trim(), ranges: [], notes: '' };
            out.innerHTML = '<pre style="margin:0">'+JSON.stringify(res,null,2)+'</pre>';
          });
        }
      }
    })(window,document);
  </script>

  <!-- Coletor + Bilingue -->
  <script defer src="./js/engine-collect.v1.js"></script>
  <script defer src="./js/i18n-bilingual.v1.js"></script>

  <!-- Hooks de validação/submissão (debug) -->
  <script>
    document.getElementById('btnMotor')?.addEventListener('click', () => {
      const data = window.EngineCollect?.collect?.() || {
        brand: window.EnginePickerState?.brand,
        model: window.EnginePickerState?.model,
        extra: window.EngineBrandState?.data
      };
      console.log('[IDMAR] Motor VALIDAR:', data);
    });
    document.getElementById('formMotor')?.addEventListener('submit', (ev) => {
      const data = window.EngineCollect?.collect?.() || {
        brand: window.EnginePickerState?.brand,
        model: window.EnginePickerState?.model,
        extra: window.EngineBrandState?.data
      };
      console.log('[IDMAR] Motor SUBMIT:', data);
    });
  </script>
</body>
</html>
