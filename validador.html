<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR · Validador (mínimo estável)</title>
  <link rel="icon" href="img/logo-pm.png" />
  <link rel="apple-touch-icon" href="img/logo-pm.png" />

  <!-- CSS base existentes -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <link rel="stylesheet" href="css/nav-ribbon.v5.css">

  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .three{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:1100px){ .three{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input, select, textarea{width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem}
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .muted{opacity:.75}
    .engine-id-visor{ margin-top:.75rem; padding:.75rem .9rem; border:1px solid var(--border); border-radius:12px; background:#f1f5f9; }
    .engine-id-title{ font-weight:700; margin-bottom:.25rem; }
    .engine-id-line{ font-weight:800; font-size:1.05rem; letter-spacing:.2px; word-break:break-word; }
    .engine-id-status{ margin-top:.35rem; font-size:.9rem; opacity:.85 }
    .ok{   background:#10b98120; border-color:#10b98180 }
    .bad{  background:#ef444420; border-color:#ef444480 }
    .warn{ background:#f59e0b20; border-color:#f59e0b80 }
    .facts{ list-style:none; padding:0; margin:.5rem 0 0 0 }
    .facts li{ margin:.25rem 0 }
    small.hint{display:block;opacity:.75;margin-top:.25rem}
  </style>

  <script>
    // Gate de sessão simples (mantém o teu comportamento)
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>
</head>
<body>
  <main class="container">
    <h1>Validador</h1>

    <section class="three">
      <!-- WIN (mantido, mas mínimo) -->
      <div class="panel">
        <h2>Validador WIN / HIN</h2>
        <label for="win">WIN / HIN</label>
        <input id="win" type="text" placeholder="Ex.: PT-ABC12345D404"/>
        <div style="margin:.5rem 0"><button id="btnWin" type="button">Validar WIN</button></div>
        <div id="winOut" class="muted"></div>
      </div>

      <!-- Motor -->
      <div class="panel">
        <h2>Validador Motor / Engine</h2>

        <div>
          <label for="brand">Marca</label>
          <select id="brand">
            <option>Yamaha</option>
            <option>Suzuki</option>
            <option>Honda</option>
            <option>Mercury</option>
            <option>Tohatsu</option>
            <option>MerCruiser</option>
            <option>Volvo Penta</option>
            <option>Yanmar</option>
            <option>Evinrude/Johnson</option>
          </select>
          <small class="hint">Podes mudar a marca a qualquer momento.</small>
        </div>

        <div style="margin-top:.5rem">
          <label for="model">Modelo (pesquisa)</label>
          <input id="model" list="modelList" placeholder="Ex.: F40 / F115B / 350 / 9.9">
          <datalist id="modelList"></datalist>
          <small class="hint">Aceita texto livre. Sugestões aparecem se existir no catálogo.</small>
        </div>

        <div class="two" style="margin-top:.5rem;display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
          <div>
            <label for="version">Versão</label>
            <select id="version"><option value="">—</option></select>
          </div>
          <div>
            <label for="power">Potência (hp)</label>
            <select id="power"><option value="">—</option></select>
          </div>
        </div>

        <div class="panel" style="margin-top:.75rem">
          <h3 style="margin:.25rem 0 .5rem">Ficha do modelo</h3>
          <ul class="facts">
            <li><strong>Potência:</strong> <span id="fact-hp">—</span> hp</li>
            <li><strong>Cilindrada:</strong> <span id="fact-cc">—</span></li>
            <li><strong>Introdução:</strong> <span id="fact-years">—</span></li>
            <li><strong>Comando:</strong> <span id="fact-rig">—</span></li>
            <li><strong>Shaft:</strong> <span id="fact-shaft">—</span></li>
            <li><strong>Rotação:</strong> <span id="fact-rot">—</span></li>
            <li><strong>Caixa:</strong> <span id="fact-case">—</span></li>
          </ul>
          <small id="fact-serial-notes" class="hint">—</small>
        </div>
      </div>

      <!-- Nº de motor -->
      <div class="panel">
        <h2>Nº do motor / Engine serial</h2>
        <input id="sn" type="text" placeholder="Ex.: BAAL-1234567 / 1B123456 / etc." autocomplete="off" />
        <div style="margin:.75rem 0 0">
          <button id="btnValidateSN" type="button">Validar nº de motor</button>
        </div>

        <div id="id-visor" class="engine-id-visor warn" aria-live="polite" style="margin-top:.75rem">
          <div class="engine-id-title">Identificador / Identifier</div>
          <div id="id-line" class="engine-id-line">—</div>
          <div id="id-status" class="engine-id-status">Aguarda campos… / Waiting…</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">IDMAR · Identificação Marítima</footer>

  <!-- =========== JS MÍNIMO =========== -->
  <script>
  (function (w, d) {
    const $  = (id) => d.getElementById(id);
    const $$ = (sel) => d.querySelector(sel);
    const j  = (...xs) => xs.filter(Boolean).join(' ');

    const els = {
      brand: $('brand'),
      model: $('model'),
      modelList: $('modelList'),
      version: $('version'),
      power: $('power'),
      sn: $('sn'),
      idLine: $('id-line'),
      idStatus: $('id-status'),
      visor: $('id-visor'),
      facts: {
        hp: $('fact-hp'),
        cc: $('fact-cc'),
        years: $('fact-years'),
        rig: $('fact-rig'),
        shaft: $('fact-shaft'),
        rot: $('fact-rot'),
        gc: $('fact-case'),
        snNotes: $('fact-serial-notes')
      }
    };

    // Catálogo v2 → índice simples por marca/modelo base
    const CAT_URL = 'data/engines_catalog.v2.json';
    let CATALOG = null;            // json completo
    let INDEX   = {};              // { brand: { base: { versions:[...], powers:Set, meta:[...] } } }

    // Heurísticas simples de formato de SN
    const SN_RULES = {
      Yamaha: [
        { re:/^[A-Z]{3,5}-?\d{5,8}$/i, hint:'Geral Yamaha (etiqueta braçadeira/BB).', strict:false },
        { re:/^[A-Z]{4}-\d{7}$/i, hint:'Formato comum “BAAL-1234567”.', strict:false }
      ],
      Honda: [
        { re:/^[A-Z]{4}-\d{7}$/i, hint:'Ex.: “BAAL-1234567”.', strict:false }
      ],
      Suzuki: [
        { re:/^[0-9A-Z]{5,12}$/i, hint:'Formas variadas Suzuki; sem checksum.', strict:false }
      ],
      Mercury: [
        { re:/^[0-9A-Z]{7,8}$/i, hint:'Mercury/Mariner comum: 7–8 carateres.', strict:false }
      ],
      'Evinrude/Johnson': [
        { re:/^[0-9A-Z\-]{6,12}$/i, hint:'OMC/BRP variados (E-TEC/legacy).', strict:false }
      ],
      Tohatsu: [{ re:/^[0-9A-Z\-]{6,12}$/i, hint:'Tohatsu/MFS/BFT variado.', strict:false }],
      'Volvo Penta': [{ re:/^[0-9A-Z\-]{6,12}$/i, hint:'Usa nº motor/drive/transom (fora do escopo).', strict:false }],
      MerCruiser: [{ re:/^[0-9A-Z\-]{6,12}$/i, hint:'Usa nº motor/drive/transom (fora do escopo).', strict:false }],
      Yanmar: [{ re:/^[0-9A-Z\-]{6,12}$/i, hint:'Etiqueta e estampagem no bloco.', strict:false }]
    };

    function norm(s){ return String(s||'').trim(); }
    function normUpper(s){ return norm(s).toUpperCase().replace(/\s+/g,''); }

    function splitBaseVariant(code){
      const m = normUpper(code).replace(/\(.*?\)/g,'').split('/')[0];
      const mm = m.match(/^([A-Z]+[0-9]+(?:\.[0-9])?)([A-Z]*)$/); // F9.9 / F115B
      return mm ? { base:mm[1], variant:mm[2]||'' } : { base:'', variant:'' };
    }

    function buildIndex(j){
      INDEX = {};
      const brands = j?.brands || {};
      Object.keys(brands).forEach(brand=>{
        const fams = brands[brand]?.families || {};
        const out  = INDEX[brand] = {};
        Object.values(fams).forEach(f=>{
          (f.versions||[]).forEach(v=>{
            const sp = splitBaseVariant(v.version||'');
            if(!sp.base) return;
            const e = out[sp.base] || (out[sp.base] = { versions:[], powers:new Set(), metas:[] });
            e.versions.push(v.version);
            if(typeof v.power === 'number') e.powers.add(v.power);
            e.metas.push(v); // guardamos meta para preencher ficha
          });
        });
      });
    }

    function fillModelDatalist(){
      els.modelList.innerHTML = '';
      const brand = els.brand.value;
      const map = INDEX[brand] || {};
      Object.keys(map).sort((a,b)=>a.localeCompare(b,'en',{numeric:true}))
        .forEach(base => {
          els.modelList.appendChild(new Option(base, base));
          // versões (ex.: F115B)
          map[base].versions.forEach(v => els.modelList.appendChild(new Option(v, v)));
        });
    }

    function showFacts(meta){
      const f = els.facts;
      if(!meta){ f.hp.textContent='—'; f.cc.textContent='—'; f.years.textContent='—';
        f.rig.textContent='—'; f.shaft.textContent='—'; f.rot.textContent='—'; f.gc.textContent='—';
        f.snNotes.textContent='—'; return; }
      f.hp.textContent = meta.power ?? '—';
      f.cc.textContent = meta.displacement_cc ?? '—';
      f.years.textContent = meta.years ?? '—';
      f.rig.textContent = meta.rigging ?? '—';
      f.shaft.textContent = meta.shaft ?? '—';
      f.rot.textContent = meta.rotation ?? '—';
      f.gc.textContent = meta.gearcase ?? '—';
      f.snNotes.textContent = meta.serial?.notes || '—';
    }

    function refreshVersionPowerFromModel(){
      const brand = els.brand.value;
      const val = normUpper(els.model.value);
      const sp = splitBaseVariant(val);
      const map = INDEX[brand] || {};
      const entry = sp.base && map[sp.base];

      // versões
      els.version.innerHTML = '<option value="">—</option>';
      if(entry){
        entry.versions.forEach(v => els.version.appendChild(new Option(v, v)));
      }

      // powers
      els.power.innerHTML = '<option value="">—</option>';
      if(entry){
        Array.from(entry.powers.values()).sort((a,b)=>a-b)
          .forEach(p => els.power.appendChild(new Option(String(p), String(p))));
      }

      // ficha
      if(entry){
        // se for versão completa, escolhe meta dessa versão; senão da primeira
        const meta = entry.metas.find(m => normUpper(m.version) === val) || entry.metas[0];
        showFacts(meta);
      }else{
        showFacts(null);
      }
    }

    function buildIdentifier(){
      const brand = els.brand.value;
      const m = norm(els.model.value);
      const ver = norm(els.version.value);
      const hp = norm(els.power.value);
      const sn = norm(els.sn.value);
      const left = j(brand, m || ver, hp ? `${hp}hp` : '');
      return j(left, sn ? `SN: ${sn}` : '').replace(/\s{2,}/g,' ');
    }

    function setVisor(status, msg){
      els.visor.classList.remove('ok','bad','warn');
      els.visor.classList.add(status);
      els.idStatus.textContent = msg;
      els.idLine.textContent = buildIdentifier() || '—';
    }

    function validateSN(){
      const brand = els.brand.value;
      const sn = norm(els.sn.value);
      if(!sn){ setVisor('warn','Introduz um nº de motor.'); return; }

      const rules = SN_RULES[brand] || [];
      const hit = rules.find(r => r.re.test(sn));
      if(hit){
        setVisor('ok', `Formato plausível (${hit.hint}).`);
      }else{
        setVisor('bad', 'Formato inesperado para a marca selecionada (heurístico).');
      }
    }

    // Eventos
    d.addEventListener('input', (ev)=>{
      if(ev.target===els.model){ refreshVersionPowerFromModel(); }
      if(ev.target===els.sn){ els.idLine.textContent = buildIdentifier(); }
    }, true);

    els.brand.addEventListener('change', ()=>{
      fillModelDatalist();
      refreshVersionPowerFromModel();
      els.idLine.textContent = buildIdentifier();
    });

    $('btnValidateSN').addEventListener('click', validateSN);

    $('btnWin').addEventListener('click', ()=>{
      const win = norm($('win').value);
      if(!win){ $('winOut').textContent = 'Introduz um WIN/HIN.'; return; }
      // Validação rápida: 12–14 chars e dígito do mês (A–L) típico
      $('winOut').textContent = /[A-L]\d{2}$/i.test(win) ? 'Formato plausível (heurístico).' : 'Formato não reconhecido (heurístico).';
    });

    function boot(){
      fetch(CAT_URL).then(r=>r.json()).then(j=>{
        CATALOG = j;
        buildIndex(j);
        fillModelDatalist();
        refreshVersionPowerFromModel();
        els.idLine.textContent = buildIdentifier();
        els.idStatus.textContent = 'Selecione/introduza modelo e nº de motor.';
      }).catch(e=>{
        console.error('Falha a carregar catálogo v2:', e);
        // Continua mesmo sem catálogo (modo texto livre)
        els.idStatus.textContent = 'Catálogo indisponível. Modo texto livre ativo.';
      });
    }
    w.addEventListener('DOMContentLoaded', boot);
  })(window, document);
  </script>
</body>
</html>

