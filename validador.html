<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR · Validador</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <link rel="stylesheet" href="css/nav-ribbon.v5.css">
  <link rel="stylesheet" href="css/engine-picker.css">
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    body{background:var(--bg);color:var(--fg);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .three{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:1100px){ .three{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input,select,textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;background:#fff}
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    .engine-id-visor{ margin-top:.75rem; padding:.75rem .9rem; border:1px solid var(--border); border-radius:12px; background:#f1f5f9; }
    .engine-id-title{ font-weight:700; margin-bottom:.25rem; }
    .engine-id-line{ font-weight:800; font-size:1.05rem; letter-spacing:.2px; word-break:break-word; }
    .engine-id-status{ margin-top:.35rem; font-size:.9rem; opacity:.8 }
    .engine-id-ok{   background:#10b98120; border-color:#10b98180 }
    .engine-id-bad{  background:#ef444420; border-color:#ef444480 }
    .engine-id-warn{ background:#f59e0b20; border-color:#f59e0b80 }
  </style>
</head>
<body>
  <main class="container">
    <h1>Validador / Validator</h1>

    <section class="three">
      <div class="panel" id="card-win">
        <h2>Validador WIN</h2>
        <label for="win">WIN / HIN</label>
        <input id="win" placeholder="Ex.: PT-ABC12345D404">
        <div style="margin-top:.5rem"><button id="btnWin">Validar WIN</button></div>
        <div id="winOut" style="margin-top:.75rem"></div>
      </div>

      <div class="panel" id="card-motor">
        <h2>Validador Motor / Engine</h2>
        <div id="engine-picker"></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.5rem">
          <div>
            <label>Modelo base</label>
            <select id="modelBaseList"><option value="">—</option></select>
          </div>
          <div>
            <label>Variante / sufixo</label>
            <select id="modelVariantList"><option value="">—</option></select>
          </div>
        </div>

        <div class="panel" style="margin-top:.75rem">
          <h3>Ficha do modelo</h3>
          <ul class="model-facts">
            <li><strong>Potência:</strong> <span id="out-hp">—</span> hp</li>
            <li><strong>Cilindrada:</strong> <span id="out-cc">—</span></li>
            <li><strong>Introdução:</strong> <span id="out-years">—</span></li>
            <li><strong>Comando:</strong> <span id="out-rig">—</span></li>
            <li><strong>Shaft:</strong> <span id="out-shaft">—</span></li>
            <li><strong>Rotação:</strong> <span id="out-rot">—</span></li>
            <li><strong>Caixa:</strong> <span id="out-case">—</span></li>
            <li><small id="out-sn-obs">—</small></li>
            <li><small id="out-sn-ranges">—</small></li>
          </ul>
        </div>
      </div>

      <div class="panel" id="card-serial">
        <h2>Nº do motor / Engine serial</h2>
        <input id="engine-sn-raw" placeholder="Ex.: BF40A-BAAL-1234567, BAAL-1234567, 1B123456" autocomplete="off">
        <div class="sn-kind" style="margin-top:.5rem">
          <label><input type="radio" name="engine-sn-kind" value="auto" checked> Auto</label>
          <label><input type="radio" name="engine-sn-kind" value="exterior"> Exterior</label>
          <label><input type="radio" name="engine-sn-kind" value="interior"> Interior</label>
        </div>
        <label style="margin-top:.5rem">Notas (motor)</label>
        <textarea id="engine-sn-notes" rows="2" placeholder="Observações do nº de série / etiqueta"></textarea>

        <div style="margin:.75rem 0 0">
          <button id="btnValidateSerial" type="button">Validar nº de motor</button>
          <button onclick="location.href='engine-history.html'" type="button" style="margin-left:.35rem">Histórico…</button>
        </div>

        <div id="engine-id-visor" class="engine-id-visor" aria-live="polite">
          <div class="engine-id-title">Identificador / Identifier</div>
          <div id="engine-id-line" class="engine-id-line">—</div>
          <div id="engine-id-status" class="engine-id-status">Aguarda campos… / Waiting…</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">IDMAR · Identificação Marítima</footer>

  <script src="js/engine-picker.js"></script>
  <script src="js/engine-history.v1.js"></script>

  <script>
    (function(w,d){
      EnginePicker.init({ dataUrl: './data/engines_catalog.v2.json' });
    })(window, document);
  </script>

  <script>
    (function(w,d){
      const baseSel = d.getElementById('modelBaseList');
      const varSel  = d.getElementById('modelVariantList');
      function split(code){ const m=String(code||'').trim().toUpperCase(); const mm=m.match(/^([A-Z]+[0-9]+(?:\.[0-9])?)([A-Z]*)/); return mm?{b:mm[1],v:mm[2]||''}:{b:'',v:''}; }
      function hydrate(){
        const m = w.EnginePickerState?.model || '';
        const sp = split(m);
        baseSel.innerHTML = '<option value="">—</option>' + (sp.b?`<option selected value="${sp.b}">${sp.b}</option>`:'');
        varSel.innerHTML  = '<option value="">—</option>' + (sp.v?`<option selected value="${sp.v}">${sp.v}</option>`:'');
      }
      w.addEventListener('input', hydrate, true);
      w.addEventListener('change', hydrate, true);
      w.addEventListener('DOMContentLoaded', hydrate);
    })(window, document);
  </script>

  <script>
    (function(w,d){
      const visor   = d.getElementById('engine-id-visor');
      const lineEl  = d.getElementById('engine-id-line');
      const statusEl= d.getElementById('engine-id-status');
      const j = (...xs)=>xs.filter(Boolean).join(' ');

      function buildReadable(){
        const brand = w.EnginePickerState?.brand || d.getElementById('engineBrand')?.value || '';
        const model = w.EnginePickerState?.model || d.getElementById('engineModel')?.value || '';
        const sn = (d.getElementById('engine-sn-raw')?.value||'').trim();
        const note = d.getElementById('engine-sn-notes')?.value || '';
        const hp = (d.getElementById('out-hp')?.textContent || '').trim();
        const left = j(brand, model, hp?`${hp}hp`:'');
        const right = sn?`SN: ${sn}`:'';
        return { text: j(left, right), brand, model, sn, note, hp };
      }

      function refresh(){
        const v = buildReadable();
        lineEl.textContent = v.text || '—';
        visor.classList.remove('engine-id-ok','engine-id-bad','engine-id-warn');
        visor.classList.add(v.sn ? 'engine-id-ok' : 'engine-id-warn');
        statusEl.textContent = v.sn ? 'Entrada pronta para registo.' : 'Introduza o nº de motor para validar/registar.';
      }

      function save(){
        const kind = (d.querySelector('input[name="engine-sn-kind"]:checked')?.value) || 'auto';
        const v = buildReadable();
        const payload = { brand: v.brand, model: v.model, family: null, serial: { raw: v.sn, kind }, notes: v.note, extra: {} };
        const saved = w.EngineHistory?.save?.(payload);
        console.log('[IDMAR] gravado no histórico:', saved);
        alert('Registo guardado no histórico.');
      }

      d.getElementById('btnValidateSerial').addEventListener('click', save);
      w.addEventListener('input',  refresh, true);
      w.addEventListener('change', refresh, true);
      w.addEventListener('DOMContentLoaded', refresh);
    })(window, document);
  </script>
</body>
</html>
