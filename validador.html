<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDMAR · Validador</title>
  <link rel="icon" href="img/logo-pm.png" />
  <link rel="apple-touch-icon" href="img/logo-pm.png" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b6bcb">

  <!-- CSS base -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/theme-soft-light.v1.css">
  <link rel="stylesheet" href="css/nav-ribbon.v5.css">

  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--bg-elev:#ffffff;--border:#e5e7eb;--link:#0b6bcb}
    html,body{height:100%}
    body{background:var(--bg);color:var(--fg);margin:0;display:flex;flex-direction:column;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
    main{flex:1}
    .container{max-width:1200px;margin:1.25rem auto;padding:0 1rem}
    .panel{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:1rem;margin:.75rem 0}
    .three{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:1100px){ .three{grid-template-columns:1fr 1fr 1fr} }
    label{display:block;margin:.35rem 0 .25rem}
    input[type="text"], input[type="search"], input[type="file"], select, textarea{
      width:100%;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.5rem .6rem;
    }
    button{background:#0b6bcb;color:#fff;border:none;border-radius:10px;padding:.55rem .9rem;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid var(--border);padding:.6rem .5rem;text-align:left}
    .footer{border-top:1px solid var(--border);padding:1rem;text-align:left;opacity:.85;background:var(--bg-elev)}
    .muted{opacity:.75}
    #engine-sn-window .chip{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:.15rem .5rem;margin:.15rem .25rem 0 0}
    #engine-sn-result ul{margin:.25rem 0 0 .9rem}

    .engine-id-visor{ margin-top:.75rem; padding:.75rem .9rem; border:1px solid var(--border); border-radius:12px; background:#f1f5f9; }
    .engine-id-title{ font-weight:700; margin-bottom:.25rem; }
    .engine-id-line{ font-weight:800; font-size:1.05rem; letter-spacing:.2px; word-break:break-word; }
    .engine-id-status{ margin-top:.35rem; font-size:.9rem; opacity:.8 }
    .engine-id-ok{   background:#10b98120; border-color:#10b98180 }
    .engine-id-bad{  background:#ef444420; border-color:#ef444480 }
    .engine-id-warn{ background:#f59e0b20; border-color:#f59e0b80 }

    /* Ficha do modelo (Cartão 2) */
    .model-facts{ list-style:none; padding:0; margin:.5rem 0 0 0 }
    .model-facts li{ margin:.25rem 0 }
    .model-facts small{ opacity:.85 }
  </style>

  <!-- Gate de sessão simples -->
  <script>
    (function(){
      try{
        var ok = sessionStorage.getItem('IDMAR_SESSION')==='ok' || sessionStorage.getItem('NAV_SESSION')==='ok';
        if(!ok) location.replace('login.html');
      }catch(e){}
    })();
  </script>

  <!-- Versão + branding -->
  <script>window.IDMAR_VERSION="Vs 1.3";</script>
  <script defer src="js/idmar-config.v4.js"></script>

  <!-- Core: i18n + header -->
  <script defer src="js/idmar-i18n.js"></script>
  <script defer src="js/idmar-header-only.all.v4.js"></script>

  <!-- Overrides (aplicam labels, ribbons e rodapé) -->
  <script defer src="js/header-override.v4.js"></script>
  <script defer src="js/i18n-boot.js"></script>
  <script defer src="js/idmar-version.v4.js"></script>
</head>

<body>
  <!-- header é injetado por JS -->

  <main class="container">
    <h1 class="card-title" data-bi-pt="Validador" data-bi-en="Validator"></h1>

    <section class="three">
      <!-- WIN -->
      <div class="panel" id="card-win">
        <h2 class="card-title" data-bi-pt="Validador WIN" data-bi-en="WIN Validator"></h2>
        <form id="formWin">
          <label for="win">WIN / HIN</label>
          <input id="win" type="text" placeholder="Ex.: PT-ABC12345D404"/>
          <div style="margin:.5rem 0"><button id="btnWin" type="submit">Validar WIN</button></div>
          <div style="margin-top:.5rem">
            <label for="winPhoto">Foto opcional / Optional photo</label>
            <input id="winPhoto" type="file" accept="image/*"/>
          </div>
          <div id="winOut" style="margin-top:.75rem"></div>
          <table>
            <thead><tr><th>Campo / Field</th><th>Valor / Value</th><th>Interpretação / Meaning</th></tr></thead>
            <tbody id="interpWinBody"></tbody>
          </table>
        </form>
      </div>

      <!-- MOTOR -->
      <div class="panel" id="card-motor">
        <h2 class="card-title" data-bi-pt="Validador Motor" data-bi-en="Engine Validator"></h2>

        <!-- Picker visível -->
        <div id="engine-picker"></div>

        <!-- Rolldown base + variante -->
        <div class="two" style="margin:.5rem 0;grid-template-columns:1fr 1fr;gap:.5rem">
          <div>
            <label>Modelo base</label>
            <select id="modelBaseList"><option value="">—</option></select>
          </div>
          <div>
            <label>Variante / sufixo</label>
            <select id="modelVariantList"><option value="">—</option></select>
          </div>
        </div>
        <input id="engineBase" type="hidden">
        <input id="engineVariant" type="hidden">

        <!-- Campos legados (escondidos) -->
        <div id="legacy-brand-model" style="display:none">
          <label for="brand">Marca</label>
          <select id="brand" data-engine-field="brand">
            <option>Yamaha</option><option>Honda</option><option>Suzuki</option><option>Tohatsu</option>
            <option>Mercury</option><option>MerCruiser</option><option>Volvo Penta</option>
            <option>Yanmar</option><option>Evinrude/Johnson</option>
          </select>

          <div id="brandDynamic"></div>

          <div style="margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem">
            <div>
              <label>Modelo (pesquisa)</label>
              <input id="srch_model" type="text" placeholder="Ex.: F40 / F115B / 350" data-engine-field="model_code"/>
            </div>
            <div>
              <label>Potência (hp)</label>
              <input id="srch_power" type="text" placeholder="Ex.: 150" data-engine-field="power"/>
            </div>
            <div>
              <label>Cilindrada (cc)</label>
              <input id="srch_disp" type="text" placeholder="Ex.: 2670" data-engine-field="displacement"/>
            </div>
            <div>
              <label>Ano</label>
              <input id="srch_year" type="text" placeholder="Ex.: 2017" data-engine-field="year"/>
            </div>
            <div>
              <label>Origem</label>
              <input id="srch_origin" type="text" placeholder="Ex.: Japão" data-engine-field="origin"/>
            </div>
          </div>
        </div>

        <!-- Family Picker (versão / potência / intervalos SN) -->
        <link rel="stylesheet" href="./css/engine-family.css">
        <div class="ef-grid">
          <div class="ef-field">
            <label for="engineVersion" class="ef-label">Versão</label>
            <select id="engineVersion" class="ef-select"><option value="">—</option></select>
          </div>
          <div class="ef-field">
            <label for="enginePower" class="ef-label">Potência</label>
            <select id="enginePower" class="ef-select"><option value="">—</option></select>
          </div>
          <div class="ef-field">
            <label class="ef-label">Nº Série (intervalos)</label>
            <div id="engineSerialInfo"></div>
          </div>
        </div>

        <!-- 🔎 Ficha do modelo selecionado -->
        <div class="panel" style="margin-top:.75rem">
          <h3 style="margin:.25rem 0 .5rem">Ficha do modelo</h3>
          <ul class="model-facts">
            <li><strong>Potência:</strong> <span id="out-hp">—</span> hp</li>
            <li><strong>Cilindrada:</strong> <span id="out-cc">—</span></li>
            <li><strong>Introdução:</strong> <span id="out-years">—</span></li>
            <li><strong>Comando:</strong> <span id="out-rig">—</span></li>
            <li><strong>Shaft:</strong> <span id="out-shaft">—</span></li>
            <li><strong>Rotação:</strong> <span id="out-rot">—</span></li>
            <li><strong>Caixa:</strong> <span id="out-case">—</span></li>
            <li><small id="out-sn-obs">—</small></li>
            <li><small id="out-sn-ranges">—</small></li>
          </ul>
        </div>
      </div>

      <!-- Nº do motor / Serial -->
      <div class="panel" id="card-serial">
        <h2 class="card-title" data-bi-pt="Nº do motor / Engine serial" data-bi-en="Engine serial"></h2>
        <input id="engine-sn-raw" type="text" placeholder="Ex.: BF40A-BAAL-1234567, BAAL-1234567, 1B123456" autocomplete="off" />
        <div class="sn-kind" style="margin-top:.5rem">
          <label><input type="radio" name="engine-sn-kind" value="auto" checked> Auto</label>
          <label><input type="radio" name="engine-sn-kind" value="exterior"> Exterior</label>
          <label><input type="radio" name="engine-sn-kind" value="interior"> Interior</label>
        </div>
        <div id="engine-sn-window" class="mt-2"></div>
        <small id="engine-sn-hints" class="muted"></small>
        <div id="engine-sn-result" class="mt-2"></div>

        <!-- Notas do nº de série -->
        <label for="engine-sn-notes" style="margin-top:.5rem">Notas (motor)</label>
        <textarea id="engine-sn-notes" rows="2" placeholder="Observações do nº de série / etiqueta"></textarea>

        <div style="margin:.75rem 0 0">
          <button id="btnValidateSerial" type="button">Validar nº de motor</button>
        </div>

        <div id="engine-id-visor" class="engine-id-visor" aria-live="polite">
          <div class="engine-id-title">Identificador / Identifier</div>
          <div id="engine-id-line" class="engine-id-line">—</div>
          <div id="engine-id-status" class="engine-id-status">Aguarda campos… / Waiting…</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer" id="fallback-footer">IDMAR · Identificação Marítima</footer>

  <!-- Scripts específicos WIN/Motor -->
  <script src="js/validador-win.r3b.js?v=r3b"></script>
  <script src="js/validador-motor.r3d.js?v=r3d"></script>
  <script defer src="js/validator-enhancements.v4.js"></script>

  <!-- Validador de combinações -->
  <script defer src="js/engine_validation.v1.js"></script>

  <!-- Ribbon Admin -->
  <script>window.IDMAR_ADMIN_URL = 'admin-engines.html';</script>
  <script defer src="js/ribbon-admin.v1.js"></script>

  <!-- PWA / SW -->
  <script defer src="./js/sw-register.js"></script>

  <!-- Engine Picker UNIFICADO -->
  <link rel="stylesheet" href="./css/engine-picker.css">
  <script defer src="./js/engine-picker.js?v=r4"></script>

  <!-- 👇 novo: shim de SN + bridge v2 -->
<script defer src="./js/engine-sn.v2.shim.js"></script>
<script defer src="./js/engine-v2-bridge.js"></script>

  <!-- Inicia o Picker com o catálogo v2 -->
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const url = './data/engines_catalog.v2.json';
    await fetch(url).then(r=>r.json());
    EnginePicker.init({ dataUrl: url });
  });
</script>

  <!-- Coletor + Bilingue -->
  <script defer src="./js/engine-collect.v1.js"></script>
  <script defer src="./js/i18n-bilingual.v1.js"></script>

  <!-- Visor do identificador composto -->
  <script>
  (function (w, d) {
    const j = (...xs) => xs.filter(Boolean).join(' ');
    const visor   = d.getElementById('engine-id-visor');
    const lineEl  = d.getElementById('engine-id-line');
    const statusEl= d.getElementById('engine-id-status');

    function buildReadableId(payload){
      const b = payload.brand || '';
      const m = payload.model || '';
      const fam = payload.family?.family || '';
      const ver = payload.family?.version || '';
      const hp  = payload.family?.power ? `${payload.family.power}hp` : '';
      const x = payload.extra || {};
      const tags = [x.rigging,x.shaft,x.rotation,x.color,x.gearcase].filter(Boolean).join(' · ');
      const left = j(b, m || fam, ver, hp);
      const right = payload.serial?.raw ? `SN: ${payload.serial.raw}` : '';
      const mid = tags ? `[${tags}]` : '';
      return j(left, mid, right).replace(/\s{2,}/g,' ');
    }

    function verdictToClass(v){ if(!v) return 'engine-id-warn'; return v.ok ? 'engine-id-ok' : 'engine-id-bad'; }

    let t=null;
    function scheduleUpdate(){ clearTimeout(t); t=setTimeout(update,80); }

    function update(){
      try{
        const data = (w.EngineCollect && w.EngineCollect.collect) ? w.EngineCollect.collect() : {};
        lineEl.textContent = buildReadableId(data) || '—';

        const ranges = data.family?.ranges || [];
        const raw = (d.getElementById('engine-sn-raw')?.value || '').trim();
        let verdict=null;
        if(raw && w.EngineSNRange && typeof w.EngineSNRange.check==='function'){
          verdict = w.EngineSNRange.check(raw, ranges);
        }

        visor.classList.remove('engine-id-ok','engine-id-bad','engine-id-warn');
        visor.classList.add(verdictToClass(verdict));
        if(!raw){
          statusEl.textContent='Selecione versão/potência e introduza o nº de motor.';
        }else if(!verdict){
          statusEl.textContent='Validação simples (sem tabela de intervalos ativa).';
        }else if(verdict.ok){
          statusEl.textContent = verdict.match
            ? `✓ Dentro do intervalo ${verdict.match.from} → ${verdict.match.to}`
            : '✓ Dentro do intervalo.';
        }else{
          statusEl.textContent = verdict.reason
            ? `✗ Fora do intervalo (${verdict.reason}).`
            : '✗ Fora do intervalo conhecido.';
        }
      }catch(e){ console.warn('[engine-id-visor] update error:', e); }
    }

    w.addEventListener('DOMContentLoaded', () => {
      d.addEventListener('input',  scheduleUpdate, true);
      d.addEventListener('change', scheduleUpdate, true);
      const sn=d.getElementById('engine-sn-raw'); if(sn) sn.addEventListener('input', scheduleUpdate);
      scheduleUpdate();
    });

    // Botão do cartão 3: mostra feedback textual no #engine-sn-result
    window.addEventListener('DOMContentLoaded', () => {
      const btn = d.getElementById('btnValidateSerial');
      const out = d.getElementById('engine-sn-result');
      function render(verdict){
        if(!out) return;
        if(!verdict){ out.innerHTML = ''; return; }
        const li = (verdict.reasons||[]).map(r=>`<li>${r}</li>`).join('');
        out.innerHTML =
          `<div class="muted" style="margin:.25rem 0">
             <strong>Marca detetada:</strong> ${verdict.brand||'—'}
             &nbsp;|&nbsp; <strong>Score:</strong> ${(verdict.score*100|0)}%
           </div>
           <ul style="margin:.25rem 0 0 .9rem">${li}</ul>`;
      }
      function run(){
        const raw = d.getElementById('engine-sn-raw')?.value || '';
        const ranges = (w.EngineCollect?.collect?.().family?.ranges) || [];
        const verdict = (w.EngineSNRange && w.EngineSNRange.check) ? w.EngineSNRange.check(raw, ranges) : null;
        render(verdict);
      }
      btn?.addEventListener('click', run);
      d.getElementById('engine-sn-raw')?.addEventListener('input', run);
      run();
    });
  })(window, document);
  </script>

  <!-- Regras de S/N + Validador v2 -->
  <script>
    window.EngineSNRules = null;
    window.addEventListener('DOMContentLoaded', () => {
      fetch('data/engine-sn-rules.v1.json')
        .then(r=>r.json())
        .then(j => { window.EngineSNRules = j; console.log('[IDMAR] SN rules v1 carregadas'); })
        .catch(e => console.warn('[IDMAR] Falha a carregar SN rules', e));
    });
  </script>
  <script defer src="js/validators/engine-sn.v2.js?v=r1"></script>

  <!-- 1) Wire que preenche a ficha e só “commit” humano foca o SN -->
  <script defer src="js/model-meta-wire.v1.js" data-json="data/engines_catalog.v2.json"></script>

  <!-- 2) Bridge v2 → Base/Variante + pesquisa por potência -->
  <script defer src="js/model-split-bridge.v2.js"></script>
</body>
</html>
